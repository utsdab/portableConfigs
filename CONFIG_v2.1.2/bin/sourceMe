#!/bin/bash
# version 0.5 mattg
# this is the confirm dialog to the initialiser
####################################################

CWD=$(pwd)
echo ">>> STARTING UTS STUDIO CONFIGURATION: "${USER}"@"$CWD
farm_config="__CENTRAL_CONFIGS__"
unset CONFIG
unset CONFIG_CENTRAL
unset CONFIG_LOCAL
unset RENDERFARM

if [ -e ~/.startDirectory ]
	then
	export STARTD=$(cat ~/.startDirectory)
	echo ">>> INFO: STARTD=${STARTD}"
else
	echo ">>> WARNING:  No ~/.startDirctory found, $STARTD not set"
fi


#### does /volumes/Renderfarm exist if it does set ${RENDERFARM}
#
renderfarm="/Volumes/Renderfarm"
if [ -e ${renderfarm} ]
then
	echo ">>> INFO: Found Renderfarm: ${renderfarm}"
	export RENDERFARM=${renderfarm}
else
	echo ">>> Cant find Renderfarm ${RENDERFARM}"
fi


###################################################
# Find or make central config for the user under farm_config/${USER}
#

if [ -e ${RENDERFARM}/${farm_config}/user/${USER}/CONFIG ] 
	then
	export CONFIG_CENTRAL=${RENDERFARM}/${farm_config}/user/${USER}/CONFIG
	echo ">>> INFO: Found Central User Configs ${CONFIG_CENTRAL}"
elif [ -e ${RENDERFARM}/${farm_config}/user/${USER} ] 
	then
	mkdir ${RENDERFARM}/${farm_config}/user/${USER}/CONFIG
	export CONFIG_CENTRAL=${RENDERFARM}/${farm_config}/user/${USER}/CONFIG
	echo ">>> INFO: Found Central User Configs (added CONFIG directory) ${CONFIG_CENTRAL}"
elif [ -e ${RENDERFARM}/${farm_config} ] 
	then
	mkdir ${RENDERFARM}/${farm_config}/user/${USER}
	mkdir ${RENDERFARM}/${farm_config}/user/${USER}/CONFIG
	export CONFIG_CENTRAL=${RENDERFARM}/${farm_config}/user/${USER}/CONFIG
	echo ">>> INFO: Found Central User Configs (added user/${USER}/CONFIG directory) ${CONFIG_CENTRAL}"
else 
	echo ">>> WARNING: Couldnt find the central configuration files ${CONFIG_CENTRAL}"
fi



################################################
#	Set the local config is running from a thumbdrive
#

if [ -e ${CWD}/bin/introduction ] 
    then
	export CONFIG_LOCAL=${CWD}
	#echo ">>> DEBUG: Set CONFIG_LOCAL to pwd "$CONFIG_LOCAL
fi


###############################################
# If both local and central exist then push the local 
# to the central then set central up to use
#

#   $CONFIG_CENTRAL looks loke /Volumes/Renderfarm/__CENTRAL_CONFIGS__/user/120988/CONFIG
#   $CONFIG_LOCAL looks loke /Volumes/MATTG/CONFIG_v0.93

if  [ ${CONFIG_CENTRAL} ] && [ ${CONFIG_LOCAL} ] && [ ${CONFIG_LOCAL} != ${CONFIG_CENTRAL} ]
    then
	echo ">>> INFO: Starting Back-up of Central Config and pushing local config to central by rsync ......"
	dateString=$(date +"%Y-%U")
	# this makes a weekly backup

	export configCentralPath=`dirname ${CONFIG_CENTRAL}`
	export backupfile="${configCentralPath}/CONFIG_BACKUP_${dateString}.tar"
	export currentConfig=`basename ${CWD}`

	
	if  [ -e ${backupfile} ]
	then
		echo ">>>     : Config backup already exists ${backupfile} "
	else
		echo ">>>     : Backing up to ${backupfile} "
		echo "        : Then rsyncing ${CONFIG_LOCAL} to ${CONFIG_CENTRAL}"

		tar  --exclude='.*' -czf ${backupfile} ${configCentralPath}/CONFIG   > /dev/null 2>&1 && rsync -rtu --delete-after ${CONFIG_LOCAL}/ ${CONFIG_CENTRAL}/ > /dev/null 2>&1 &

	fi
	
	echo ">>>     : Config Local   is ${CONFIG_LOCAL}"
	echo ">>>     : Config Central is ${CONFIG_CENTRAL}"
	export CONFIG=${CONFIG_LOCAL}

elif [ ${CONFIG_LOCAL} ]
	then
	echo ">>> INFO: Found local config only"
	export CONFIG=${CONFIG_LOCAL}


else
	echo ">>> INFO: ** Not Backing up Configs "
fi


######	Finally source the shell setup routine
#
if [ ${CONFIG} ] 
then
	source ${CONFIG}/bin/introduction
elif [ ${CONFIG_LOCAL} ]
	then
	export CONFIG=${CONFIG_LOCAL}
	alias intro="source ${CONFIG}/bin/introduction"
	source ${CONFIG}/bin/introduction
else
	echo "WARNING: cant find configs locally or centrally... oops"
fi



if [ -f ${DABRENDERPATH}/usr/etc/profile ] ; then
    . ${DABRENDERPATH}/usr/etc/profile

elif  [ -f /usr/local/dabanim/etc/profile ] ; then 
    . /usr/local/dabanim/etc/profile

else
    echo "CRITICAL: Cant set profile correctly from central or local"
	unset DABRENDERPATH
fi
